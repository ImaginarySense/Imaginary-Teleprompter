// Generated by CoffeeScript 1.4.0
var match, normalize, querystring, utils,
  __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

utils = require('../utils');

querystring = {
  unescape: function(str) {
    return decodeURIComponent(str);
  },
  parse: function(qs, sep, eq) {
    var k, kvp, obj, v, vkps, x, _i, _len, _ref;
    sep = sep || '&';
    eq = eq || '=';
    obj = {};
    if (typeof qs !== 'string') {
      return obj;
    }
    vkps = qs.split(sep);
    for (_i = 0, _len = vkps.length; _i < _len; _i++) {
      kvp = vkps[_i];
      x = kvp.split(eq);
      k = querystring.unescape(x[0], true);
      v = querystring.unescape(x.slice(1).join(eq), true);
      if (_ref = !k, __indexOf.call(obj, _ref) >= 0) {
        obj[k] = v;
      } else if (!Array.isArray(obj[k])) {
        obj[k] = [obj[k], v];
      } else {
        obj[k].push(v);
      }
    }
    return obj;
  }
};

normalize = function(command, keys, sensitive) {
  command = command.concat('/?').replace(/\/\(/g, '(?:/').replace(/:(\w+)(\(.*\))?(\?)?/g, function(_, key, format, optional) {
    keys.push(key);
    format = format || '([^ ]+)';
    optional = optional || '';
    return format + optional;
  }).replace(/([\/.])/g, '\\$1').replace(/\*/g, '(.+)');
  return new RegExp('^' + command + '$', (sensitive != null ? 'i' : void 0));
};

match = function(req, routes, i) {
  var captures, index, j, key, keys, regexp, route, val;
  if (i == null) {
    i = 0;
  }
  while (i < routes.length) {
    route = routes[i];
    regexp = route.regexp;
    keys = route.keys;
    captures = regexp.exec(req.command);
    if (captures) {
      route.params = {};
      index = 0;
      j = 1;
      while (j < captures.length) {
        key = keys[j - 1];
        val = typeof captures[j] === 'string' ? querystring.unescape(captures[j]) : captures[j];
        if (key) {
          route.params[key] = val;
        } else {
          route.params['' + index] = val;
          index++;
        }
        j++;
      }
      req._route_index = i;
      return route;
    }
    i++;
  }
  return null;
};

module.exports = function(settings) {
  var params, routes, shell, _ref;
  if (!settings.shell) {
    throw new Error('No shell provided');
  }
  shell = settings.shell;
  if ((_ref = settings.sensitive) == null) {
    settings.sensitive = true;
  }
  routes = shell.routes = [];
  params = {};
  shell.param = function(name, fn) {
    if (Array.isArray(name)) {
      name.forEach(function(name) {
        return this.param(name, fn);
      }, this);
    } else {
      if (':' === name[0]) {
        name = name.substr(1);
      }
      params[name] = fn;
    }
    return this;
  };
  shell.cmd = function(command, description, middleware1, middleware2, fn) {
    var args, keys, route;
    args = Array.prototype.slice.call(arguments);
    route = {};
    route.command = args.shift();
    if (typeof args[0] === 'string') {
      route.description = args.shift();
    }
    route.middlewares = utils.flatten(args);
    keys = [];
    route.regexp = route.command instanceof RegExp ? route.command : normalize(route.command, keys, settings.sensitive);
    route.keys = keys;
    routes.push(route);
    return this;
  };
  shell.cmd('quit', 'Exit this shell', shell.quit.bind(shell));
  return function(req, res, next) {
    var i, pass, route, self;
    route = null;
    self = this;
    i = 0;
    pass = function(i) {
      var keys, param;
      route = match(req, routes, i);
      if (!route) {
        return next();
      }
      i = 0;
      keys = route.keys;
      req.params = route.params;
      param = function(err) {
        var fn, key, nextMiddleware, val;
        try {
          key = keys[i++];
          val = req.params[key];
          fn = params[key];
          if ('route' === err) {
            return pass(req._route_index + 1);
          } else if (err) {
            return next(err);
          } else if (fn) {
            if (1 === fn.length) {
              req.params[key] = fn(val);
              return param();
            } else {
              return fn(req, res, param, val);
            }
          } else if (!key) {
            i = 0;
            nextMiddleware = function(err) {
              fn = route.middlewares[i++];
              if ('route' === err) {
                return pass(req._route_index + 1);
              } else if (err) {
                return next(err);
              } else if (fn) {
                return fn(req, res, nextMiddleware);
              } else {
                return pass(req._route_index + 1);
              }
            };
            return nextMiddleware();
          } else {
            return param();
          }
        } catch (err) {
          return next(err);
        }
      };
      return param();
    };
    return pass();
  };
};
