<!DOCTYPE html>
<!--
	Teleprompter
	Copyright (C) 2015 Imaginary Films LLC, Victor Ortiz <va2ron1@gmail.com>, Javier Cordero <javier.cordero@upr.edu>

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation, either version 3 of the License, or
	(at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>

<head>
    <meta content="text/html; charset=windows-1252" http-equiv="content-type">
    <title>Output | Teleprompter by Imaginary Films</title>
    <link href="favicon.ico" rel="icon" type="image/x-icon" />
    <script src="js/jquery.min.js"></script>
    <script src="js/pep.min.js"></script>
    <link rel="stylesheet" href="ckeditor/contents.css">
    <link rel="stylesheet" href="css/prompterstyle.css"> </head>

<body>
    <table border="0" cellpadding="0" cellspacing="0" id="overlay" class="cke_editable">
        <tbody>
            <tr id="overlayTop" class="overlayBg">
                <td> </td>
            </tr>
            <tr id="overlayFocus">
                <td>
                    <div id="arrow"></div>
                </td>
            </tr>
            <tr id="overlayBottom" class="overlayBg">
                <td> </td>
            </tr>
        </tbody>
    </table>
    <div id="scroll_wrapper">
        <div id="text_block" class="cke_editable" touch-action="pan-y"></div>
    </div>
    <script>
    (function () {
    //Encapsulate the code in an anonymous function to not fill the global object. (Window)
    //JavaSript Strict
    "use strict";
    var play = false;
    var flipH = false;
    var flipV = false;
    //p Find ways to make scrolling units equivalent across all screen heights...
    var unit = 1; //prompt.clientHeight/300; //'1vh';
    var speed = unit; // initial speed
    var sensitivity = 1.8;
    var limit = 40 / sensitivity;
    var wrapper = $('#scroll_wrapper');
    var wrapperById = document.getElementById('scroll_wrapper');
    var prompt = document.getElementById('text_block');
    // Parse values from localStorage
    var obj = JSON.parse(localStorage.getItem('data'));
    prompt.innerHTML = decodeURIComponent(obj.html);
    var timeoutStat;

    function negSpeed() {
      // Compare speed and limit then multiply by -1 to invert the boolean value
        if (speed > limit * -1)
            speed -= unit;
    }

    function posSpeed() {
        if (speed < limit)
            speed += unit;
    }

    function doScroll() {
        wrapper.animate({
            scrollTop: "+=" + speed
        }, {
            duration: 50 - Math.abs(speed * sensitivity),
            complete: function() {
                window.setTimeout(doScroll, 0);
            }
        });
    }

    function togglePlay() {
        play = !play;
        if (play)
            doScroll();
        else
            wrapper.stop();
    }

    function inIframe() {
        try {
            return window.self !== window.top;
        } catch (e) {
            return true;
        }
    }

    function returnToEditor() {
        if (inIframe()) {
            $('#content', parent.document).css({
                "display": "block"
            });
            $('#editor', parent.document).css({
                "display": "block"
            });
            $('#footer', parent.document).css({
                "display": "block"
            });
            $('#framecontainer', parent.document).css({
                "display": "none"
            });
            this.document.location.href = "about:blank";
        } else
            window.close();
    }

    document.onkeydown = function(evt) {
        // Change speed toward intended direction.
        evt = evt || window.event;
        switch (evt.keyCode) {
            case 37: // Left
            case 38: // Up
            case 87: // W
            case 65: // A
                if (flipV)
                    posSpeed();
                else
                    negSpeed();
                break;
            case 39: // Right
            case 40: // Down
            case 83: // S
            case 68: // D
                if (flipV)
                    negSpeed();
                else
                    posSpeed();
                break;
            case 32: // Spacebar
                togglePlay();
                break;
            case 27:
                returnToEditor();
                break;
                /*
                default:
                	if ( char in arrayOfAnchors )
                		scrollTop( getAnchor(char).pos - wrapperById.clientHeight/2 );
                */
        }

        // Prevent arrow and spacebar scroll bug.
        if ([32, 37, 38, 39, 40].indexOf(evt.keyCode) > -1)
            evt.preventDefault();
    };

    // Reset speed to 0 when reaching Top or Bottom.
    wrapper.scroll(function() {
        var currPos = wrapper.scrollTop();
        if (currPos === 0 || currPos + wrapperById.clientHeight == prompt.clientHeight)
            speed = 0;
    });

    function timeout(event) {
        wrapper.stop();
        play = false;
        if (timeoutStat) {
            window.clearTimeout(timeoutStat);
        }
        timeoutStat = window.setTimeout(togglePlay, 1000);
    }

    $(window).bind('wheel', timeout);
    //wrapper.bind('scrollBar', timeout);  //p 

    $("#text_block").on("pointermove", function(event) {
        console.log("pointer in action");
        //timeout();
    });

    function init() {
        // Local variables (All variables in javascript are function scope not block scope)
        var promptStyle = false;
        var focus = 0;
        var i = 0;
        var overBgs = document.getElementsByClassName('overlayBg');

        // Get JSON values from local storage
        var flip = obj.data.secondary;
        console.log(flip);
        switch (flip) {
            case 2:
                flipH = true;
                break;
            case 3:
                flipV = true;
                break;
            case 4:
                flipH = true;
                flipV = true;
                break;
        }

        focus = obj.data.focus;
        promptStyle = obj.data.prompterStyle;

        if (flipH) {
            // Flip Horizontally
            prompt.style.MozTransform = "scaleX(-1)";
            prompt.style.OTransform = "scaleX(-1)";
            prompt.style.webkitTransform = "scaleX(-1)";
            prompt.style.transform = "scaleX(-1)";
            prompt.style.filter = "FlipH";
            prompt.style.msFilter = "FlipH";
        }
        if (flipV) {
            // Flip Vertically
            prompt.style.MozTransform = "scaleY(-1)";
            prompt.style.OTransform = "scaleY(-1)";
            prompt.style.webkitTransform = "scaleY(-1)";
            prompt.style.transform = "scaleY(-1)";
            prompt.style.filter = "FlipV";
            prompt.style.msFilter = "FlipV";

            //b Asynchronism bug. If onload browser hasn't set dom height, scrollTop waits and speed is set to 0, also sometimes incorrect scroll is set.
            // Start scroll at inverted top
            wrapper.scrollTop(prompt.offsetHeight - wrapperById.clientHeight - 30);

            // If focus is top or bottom, change overlay positions
            if (focus == 1)
                document.getElementById("overlayBottom").style.height = '1vh';
            else if (focus == 2)
                document.getElementById("overlayTop").style.height = '10%';

            // Reverse initial speed
            speed *= -1;
        } else // If no vertical flip
        {
            // If focus is top or bottom, change overlay positions.
            if (focus == 1)
                document.getElementById("overlayTop").style.height = '10%';
            else if (focus == 2)
                document.getElementById("overlayBottom").style.height = '1vh';
        }

        // Set Teleprompter Style
        switch (promptStyle) {
            case 1:
                document.body.style.background = '#FFF';
                document.body.style.color = '#000';
                for (i = 0; i < overBgs.length; i++)
                    overBgs[i].style.backgroundColor = '#BBB';
                break;
            default:
                document.body.style.background = '#272822';
                document.body.style.color = '#FFF';
                for (i = 0; i < overBgs.length; i++)
                    overBgs[i].style.backgroundColor = '#000';
        }

        // Start scrolling
        togglePlay();
    }
    document.body.onload = init();
}());
    </script>
</body>

</html>